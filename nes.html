<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES ì—ë®¬ë ˆì´í„° - ì ¤ë‹¤ ì„¸ì´ë¸Œ ì™„ë²½ í•´ê²° (SRAM í¬í•¨)</title>
    <style>
        body { font-family: Arial, sans-serif; background: #222; color: #fff; padding: 20px; }
        canvas { border: 2px solid #fff; image-rendering: pixelated; display: block; margin: 20px auto; background: #000; }
        form { margin: 20px 0; background: #333; padding: 15px; border-radius: 5px; }
        label { display: block; margin: 10px 0; }
        input[type="text"] { width: 100px; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .instructions { background: #ff9800; padding: 15px; border-radius: 5px; margin: 20px 0; color: #000; }
        .zelda-guide { background: #2196F3; color: white; }
        .success { background: #4CAF50; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
    <script src="https://unpkg.com/nostalgist@latest/dist/nostalgist.umd.js"></script>
</head>
<body>
    <h1>ğŸ† NES ì ¤ë‹¤ ì—ë®¬ë ˆì´í„° (SRAM + í€µì„¸ì´ë¸Œ ì™„ë²½!)</h1>
    <p>.nes ë˜ëŠ” .fds ROM ì„ íƒ â†’ Play! (ì„¸ì´ë¸Œ ìë™ ë³µì›)</p>
    <input type="file" id="romFile" accept=".nes,.fds">
    <button onclick="loadROM()">Play</button>
    <button onclick="restartEmulator()" style="background: #2196F3;">ì¬ì‹œì‘</button>

    <div class="instructions zelda-guide">
        <h3>ğŸ”¥ ì„¸ì´ë¸Œ ì„ íƒ í™”ë©´ì—ì„œ</h3>
        <ul>
            <li>NEW GAME ì„ íƒ â†’ Enter ëˆŒëŸ¬ ì´ë¦„ ì…ë ¥</li>
            <li>ê¸°ì¡´ ì„¸ì´ë¸Œ (ë§í¬ ì¸í˜•) â†’ X ëˆŒëŸ¬ ë¡œë“œ</li>
            <li>KILL MODE: ì„¸ì´ë¸Œ ì‚­ì œ (ì£¼ì˜!)</li>
        </ul>
    </div>

    <div class="instructions">
        <h3>ğŸ’¾ ê²Œì„ ë‚´ ì„¸ì´ë¸Œ (í•„ìˆ˜!)</h3>
        <ul>
            <li>í”Œë ˆì´ ì¤‘ Enter(Start) â†’ ì¸ë²¤í† ë¦¬</li>
            <li>F1 + F2 ë™ì‹œì— â†’ ì„¸ì´ë¸Œ ë©”ë‰´</li>
            <li>ìŠ¬ë¡¯ ì„ íƒ â†’ X(A) â†’ ì €ì¥</li>
            <li>ì£½ìœ¼ë©´ ì„¸ì´ë¸Œ ì„ íƒ í™”ë©´ìœ¼ë¡œ â†’ ë¡œë“œ</li>
        </ul>
        <p><em>ì£½ê¸° ì „ì— ê²Œì„ ë‚´ ì„¸ì´ë¸Œ + í€µì„¸ì´ë¸Œ ë²„íŠ¼ ëˆŒëŸ¬!</em></p>
    </div>

    <div class="instructions">
        <h3>âš¡ í€µì„¸ì´ë¸Œ (ì¶”ê°€)</h3>
        <ul>
            <li>ê²Œì„ ë‚´ ì„¸ì´ë¸Œ í›„ ë²„íŠ¼ ëˆŒëŸ¬</li>
            <li>í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•´ë„ ë³µì› (SRAM í¬í•¨)</li>
        </ul>
    </div>

    <div>
        <h2>ğŸ® P1 ì»¨íŠ¸ë¡¤</h2>
        <form id="controlsFormP1">
            <label>A: <input id="aKey" type="text" value="x"></label>
            <label>B: <input id="bKey" type="text" value="z"></label>
            <label>SELECT: <input id="selectKey" type="text" value="tab"></label>
            <label>START: <input id="startKey" type="text" value="enter"></label>
            <label>â†‘: <input id="upKey" type="text" value="up"></label>
            <label>â†“: <input id="downKey" type="text" value="down"></label>
            <label>â†: <input id="leftKey" type="text" value="left"></label>
            <label>â†’: <input id="rightKey" type="text" value="right"></label>
        </form>
    </div>

    <div>
        <h2>ğŸ’¾ P2 í‚¤ (ì„¸ì´ë¸Œ)</h2>
        <form id="controlsFormP2">
            <label>P2 â†‘: <input id="p2upKey" type="text" value="f1"></label>
            <label>P2 A: <input id="p2aKey" type="text" value="f2"></label>
        </form>
        <button onclick="saveAllControls()" style="background: #FF9800;">í‚¤ ì €ì¥</button>
    </div>

    <div>
        <h2>í€µì„¸ì´ë¸Œ</h2>
        <button onclick="saveGameState()" style="background: #FF9800;">ğŸ›¡ï¸ ì„¸ì´ë¸Œ (SRAM+ë‹¤ìš´)</button>
        <button onclick="clearAutoSave()" style="background: #f44336;">ğŸ—‘ï¸ ì‚­ì œ</button>
        <br>
        <input type="file" id="stateFile" accept=".sta">
        <button onclick="loadGameState()">ğŸ“ ë¡œë“œ</button>
    </div>

    <script>
        let nostalgist;
        let currentRomHash = '';
        let romName = '';
        let customControls = {
            input_player1_a: 'x',
            input_player1_b: 'z',
            input_player1_select: 'tab',
            input_player1_start: 'enter',
            input_player1_up: 'up',
            input_player1_down: 'down',
            input_player1_left: 'left',
            input_player1_right: 'right',
            input_player2_up: 'f1',
            input_player2_a: 'f2'
        };

        // Base64 í•¨ìˆ˜
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function base64ToBlob(base64) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray]);
        }

        async function getRomHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function loadControls() {
            const saved = localStorage.getItem('nesControls');
            if (saved) customControls = JSON.parse(saved);
            document.getElementById('aKey').value = customControls.input_player1_a;
            document.getElementById('bKey').value = customControls.input_player1_b;
            document.getElementById('selectKey').value = customControls.input_player1_select;
            document.getElementById('startKey').value = customControls.input_player1_start;
            document.getElementById('upKey').value = customControls.input_player1_up;
            document.getElementById('downKey').value = customControls.input_player1_down;
            document.getElementById('leftKey').value = customControls.input_player1_left;
            document.getElementById('rightKey').value = customControls.input_player1_right;
            document.getElementById('p2upKey').value = customControls.input_player2_up;
            document.getElementById('p2aKey').value = customControls.input_player2_a;
        }

        function saveAllControls() {
            customControls.input_player1_a = document.getElementById('aKey').value.toLowerCase().trim();
            customControls.input_player1_b = document.getElementById('bKey').value.toLowerCase().trim();
            customControls.input_player1_select = document.getElementById('selectKey').value.toLowerCase().trim();
            customControls.input_player1_start = document.getElementById('startKey').value.toLowerCase().trim();
            customControls.input_player1_up = document.getElementById('upKey').value.toLowerCase().trim();
            customControls.input_player1_down = document.getElementById('downKey').value.toLowerCase().trim();
            customControls.input_player1_left = document.getElementById('leftKey').value.toLowerCase().trim();
            customControls.input_player1_right = document.getElementById('rightKey').value.toLowerCase().trim();
            customControls.input_player2_up = document.getElementById('p2upKey').value.toLowerCase().trim();
            customControls.input_player2_a = document.getElementById('p2aKey').value.toLowerCase().trim();
            localStorage.setItem('nesControls', JSON.stringify(customControls));
            alert('í‚¤ ì €ì¥ë¨! ì¬ì‹œì‘ ì ìš©');
        }

        loadControls();

        async function loadROM() {
            const file = document.getElementById('romFile').files[0];
            if (!file) return alert('ROM ì„ íƒ!');
            romName = file.name.replace(/\.[^/.]+$/, "");
            const romHash = await getRomHash(file);
            currentRomHash = romHash;
            try {
                nostalgist = await Nostalgist.launch({
                    core: 'fceumm',
                    rom: file,
                    retroarchConfig: customControls
                });

                // SRAM ë³µì›
                const srmKey = `nesSRAM_${romHash}`;
                const srmBase64 = localStorage.getItem(srmKey);
                if (srmBase64) {
                    const srmBlob = base64ToBlob(srmBase64);
                    const srmBuffer = await srmBlob.arrayBuffer();
                    const srmUint8 = new Uint8Array(srmBuffer);
                    const fs = nostalgist.getEmscriptenFS();
                    const srmPath = `/home/web_user/retroarch/userdata/saves/${romName}.srm`;
                    fs.mkdirTree('/home/web_user/retroarch/userdata/saves'); // ë””ë ‰í† ë¦¬ í™•ë³´
                    fs.writeFile(srmPath, srmUint8);
                    console.log('SRAM ë³µì›ë¨!');
                }

                // í€µì„¸ì´ë¸Œ ë¡œë“œ
                const savedKey = `nesState_${romHash}`;
                const base64 = localStorage.getItem(savedKey);
                if (base64) {
                    const blob = base64ToBlob(base64);
                    setTimeout(async () => {
                        await nostalgist.loadState(blob);
                    }, 1000);
                }

                // í¬ì»¤ìŠ¤
                setTimeout(() => {
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.tabIndex = 1;
                        canvas.focus();
                        canvas.click();
                    }
                }, 1500);

                alert('ğŸ® ë¡œë“œë¨! (SRAM + í€µì„¸ì´ë¸Œ ë³µì›)');
            } catch (e) {
                console.error(e);
                alert('ë¡œë“œ ì‹¤íŒ¨!');
            }
        }

        async function saveGameState() {
            if (!nostalgist) return alert('ê²Œì„ ì‹œì‘!');
            try {
                // SRAM í”ŒëŸ¬ì‹œ
                if (nostalgist.saveSRAM) await nostalgist.saveSRAM();

                // ìƒíƒœ ì €ì¥
                const { state } = await nostalgist.saveState();
                const stateBase64 = await blobToBase64(state);
                localStorage.setItem(`nesState_${currentRomHash}`, stateBase64);

                // SRAM ë°ì´í„° ì½ê¸°
                const fs = nostalgist.getEmscriptenFS();
                const srmPath = `/home/web_user/retroarch/userdata/saves/${romName}.srm`;
                if (fs.existsSync(srmPath)) {
                    const srmData = fs.readFile(srmPath, {encoding: 'binary'});
                    const srmBase64 = await blobToBase64(new Blob([srmData]));
                    localStorage.setItem(`nesSRAM_${currentRomHash}`, srmBase64);
                    console.log('SRAM ì €ì¥ë¨!');
                }

                // ë‹¤ìš´ë¡œë“œ (í€µì„¸ì´ë¸Œ)
                const url = URL.createObjectURL(state);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'zelda_quick.sta';
                a.click();
                URL.revokeObjectURL(url);

                alert('ğŸ’¾ ì„¸ì´ë¸Œ ì™„ë£Œ! (SRAM í¬í•¨)');
            } catch (e) {
                alert('ì‹¤íŒ¨: ' + e.message);
            }
        }

        function clearAutoSave() {
            if (currentRomHash) {
                localStorage.removeItem(`nesState_${currentRomHash}`);
                localStorage.removeItem(`nesSRAM_${currentRomHash}`);
                alert('ğŸ—‘ï¸ ì‚­ì œë¨!');
            }
        }

        async function loadGameState() {
            if (!nostalgist) return alert('ê²Œì„ ì‹œì‘!');
            const file = document.getElementById('stateFile').files[0];
            if (!file) return alert('íŒŒì¼ ì„ íƒ!');
            try {
                await nostalgist.loadState(file);
                alert('ë¡œë“œ ì™„ë£Œ!');
            } catch (e) {
                alert('ì‹¤íŒ¨');
            }
        }

        async function restartEmulator() {
            if (nostalgist) await nostalgist.destroy().catch(() => {});
            loadROM();
        }
    </script>
</body>
</html>